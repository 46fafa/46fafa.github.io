{{ define "body-class" }}
    article-page
{{ end }}
{{ define "main" }}
    <div class="article-content">
        {{ .Content }}
    </div>
    
    {{ $movieData := sort .Site.Data.movie "date" "desc" }}
    {{ $tvData := sort .Site.Data.tv "date" "desc" }}
    {{ $bookData := sort .Site.Data.book "date" "desc" }}

    {{ $currentYear := now.Format "2006" }}

    {{ $stats := dict }}
    {{ $mediaTypes := slice 
        (dict "type" "movie" "name" "电影" "data" $movieData "statName" "电影")
        (dict "type" "tv" "name" "剧集" "data" $tvData "statName" "电视剧")
        (dict "type" "book" "name" "书籍" "data" $bookData "statName" "书")
    }}

    {{ range $mediaTypes }}
        {{ $count := 0 }}
        {{ range .data }}
            {{ $itemYear := substr .date 0 4 }}
            {{ if eq $itemYear $currentYear }}
                {{ $count = add $count 1 }}
            {{ end }}
        {{ end }}
        {{ $stats = merge $stats (dict .type $count) }}
    {{ end }}

    <p class="yearly-stats">
        <span>{{ $currentYear }}</span>年看了
        <span>{{ index $stats "book" }}</span>本{{ (index $mediaTypes 2).statName }},
        <span>{{ index $stats "movie" }}</span>部{{ (index $mediaTypes 0).statName }},
        <span>{{ index $stats "tv" }}</span>部{{ (index $mediaTypes 1).statName }}.
    </p>

    {{ $firstActiveType := "movie" }}
    <div class="type-buttons">
        {{ range $mediaTypes }}
            <button class="type-btn{{ if eq .type $firstActiveType }} active{{ end }}" data-type="{{ .type }}">{{ .name }}</button>
        {{ end }}
    </div>

    {{ range $mediaTypes }}
        {{ if .data }}
            <div class="media-grid{{ if eq .type $firstActiveType }} active{{ end }}" data-type="{{ .type }}">
                {{ partial "media/grid" (dict "data" .data "type" .type "firstActiveType" $firstActiveType) }}
            </div>
        {{ end }}
    {{ end }}

    {{ if not (eq .Params.comments false) }}
        {{ partial "comments/include" . }}
    {{ end }}
    {{ if .Params.twikooStyle }}
    {{ end }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const typeButtons = document.querySelectorAll('.type-btn');
            const grids = document.querySelectorAll('.media-grid');
            const showMoreButtons = document.querySelectorAll('.show-more-btn');
            
            function showType(type) {
                typeButtons.forEach(btn => btn.classList.remove('active'));
                grids.forEach(grid => grid.classList.remove('active'));
                const activeBtn = document.querySelector(`.type-btn[data-type="${type}"]`);
                const activeGrid = document.querySelector(`.media-grid[data-type="${type}"]`);

                if (activeBtn) activeBtn.classList.add('active');
                if (activeGrid) activeGrid.classList.add('active');
            }
            
            const initialType = '{{ $firstActiveType }}';
            showType(initialType);
            
            typeButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const type = this.dataset.type;
                    showType(type);
                });
            });
            
            showMoreButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const type = this.dataset.type;
                    const grid = document.querySelector(`.media-grid[data-type="${type}"]`);
                    const hiddenGroups = grid.querySelectorAll('.year-group.hidden');
                    
                    const groupsToShow = Math.min(2, hiddenGroups.length);
                    
                    for (let i = 0; i < groupsToShow; i++) {
                        hiddenGroups[i].classList.remove('hidden');
                    }
                    
                    if (hiddenGroups.length <= groupsToShow) {
                        this.style.display = 'none';
                    }
                });
            });
        });
    </script>
{{ end }}